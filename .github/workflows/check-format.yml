name: Check Code Formatting

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  clang-format-check:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Install Python libraries
        run: |
          pip install PyGithub

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          separator: ","

      - name: Run Format Assistant
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # We pass the input arguments dynamically based on the PR context
          python ci/format-code.py \
            --token "$GITHUB_TOKEN" \
            --repo "${{ github.repository }}" \
            --issue-number "${{ github.event.pull_request.number }}" \
            --pr-rev "${{ github.event.pull_request.head.sha }}" \
            --base-rev "${{ github.event.pull_request.base.sha }}" \
            --changed-files "${{ steps.changed-files.outputs.all_changed_files }}" \
            --write-comments-on-pr