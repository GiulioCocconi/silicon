name: Build CI

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - '**.cpp'
      - '**.hpp'
      - '**/CMakeLists.txt'
      - '**.cmake'
      - 'flake.nix'
      - 'flake.lock'
      - '.github/workflows/build.yml'
      - 'vcpkg.json'
  push:
    branches: [ "main" ]
    paths:
      - '**.cpp'
      - '**.hpp'
      - '**/CMakeLists.txt'
      - '**.cmake'
      - 'flake.nix'
      - 'flake.lock'
      - '.github/workflows/build.yml'
      - 'vcpkg.json'

jobs:
  set-label:
    if: github.event_name == 'pull_request'
    name: Set build label
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "build" \
            --repo ${{ github.repository }}


  # -----------------------------------------------------------------------------
  # LINUX BUILD (Nix Flakes)
  # -----------------------------------------------------------------------------
  build-linux:
    name: Linux (Nix)
    runs-on: ubuntu-latest

    permissions:
      id-token: "write"
      contents: "read"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Cache Nix store
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Build with Nix
        run: nix build --print-build-logs

  # -----------------------------------------------------------------------------
  # WINDOWS BUILD (MinGW + vcpkg)
  # -----------------------------------------------------------------------------
  build-windows:
    name: Windows (MinGW)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup MinGW
        uses: egor-tensin/setup-mingw@v3

      - name: Install Ninja
        run: choco install ninja

      # Caching is critical for Windows/vcpkg to avoid hour-long builds
      - name: Restore vcpkg Cache
        uses: actions/cache@v5
        id: vcpkg-cache
        with:
          path: |
            build/vcpkg_installed
            build/_deps
          # Invalidate cache if vcpkg manifest changes
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Configure CMake
        # Setting CC/CXX ensures CMake picks up MinGW instead of MSVC
        run: |
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Debug -Bbuild
        env:
          CC: gcc
          CXX: g++

      - name: Build
        run: ninja -C build

      - name: Test
        run: ctest --test-dir build


  # -----------------------------------------------------------------------------
  # WASM BUILD (Linux + Emscripten)
  # -----------------------------------------------------------------------------
  build-wasm:
    name: WASM (Emscripten)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Install Emscripten
        uses: mymindstorm/setup-emsdk@v13
        with:
          version: 4.0.7

      - name: Install Qt for WASM
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.11.0"
          host: "all_os"
          target: "wasm"
          arch: "wasm_singlethread"

      - name: Install Ninja and range-v3
        run: sudo apt-get install ninja-build

      - name: Configure CMake
        run: |
          chmod +x ~/work/silicon/Qt/6.11.0/wasm_singlethread/bin/qt-cmake
          ~/work/silicon/Qt/6.11.0/wasm_singlethread/bin/qt-cmake -Bbuild -G Ninja
          emcmake cmake -G Ninja -DCMAKE_BUILD_TYPE=Debug -Bbuild

      - name: Build
        run: ninja -C build

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: silicon-wasm
          path: |
            bin/*.js
            bin/*.wasm
            bin/*.html
          retention-days: 30