name: PR Compliance Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Check commit sign-offs
        id: signoff
        run: |
          echo "Checking commits for sign-offs..."
          UNSIGNED_COMMITS=""
          
          # Get list of commits in the PR
          COMMITS=$(git log --format="%H" origin/${{ github.event.pull_request.base.ref }}..HEAD)
          
          for commit in $COMMITS; do
            # Check if commit message contains "Signed-off-by"
            if ! git log --format=%B -n 1 $commit | grep -q "^Signed-off-by:"; then
              COMMIT_MSG=$(git log --format="%s" -n 1 $commit)
              COMMIT_AUTHOR=$(git log --format="%an" -n 1 $commit)
              UNSIGNED_COMMITS="${UNSIGNED_COMMITS}* ${commit:0:7} - \"$COMMIT_MSG\" by $COMMIT_AUTHOR\n"
            fi
          done
          
          if [ -n "$UNSIGNED_COMMITS" ]; then
            echo "has_unsigned=true" >> $GITHUB_OUTPUT
            echo -e "$UNSIGNED_COMMITS" > unsigned_commits.txt
            exit 1
          else
            echo "has_unsigned=false" >> $GITHUB_OUTPUT
            echo "All commits are signed off ✓"
          fi

      - name: Check commit message format
        id: commit_format
        if: always()
        run: |
          echo "Checking commit message format..."
          INVALID_COMMITS=""
          
          # Allowed types from CONTRIBUTING.md
          TYPES="feat|fix|docs|style|refactor|perf|test|build|chore|revert|contributors|misc"
          
          COMMITS=$(git log --format="%H" origin/${{ github.event.pull_request.base.ref }}..HEAD)
          
          for commit in $COMMITS; do
            COMMIT_MSG=$(git log --format=%s -n 1 $commit)
            
            # Check if commit message follows the format: type(scope): description or type: description
            if ! echo "$COMMIT_MSG" | grep -qE "^($TYPES)(\(.+\))?: .+"; then
              COMMIT_AUTHOR=$(git log --format="%an" -n 1 $commit)
              INVALID_COMMITS="${INVALID_COMMITS}* ${commit:0:7} - \"$COMMIT_MSG\" by $COMMIT_AUTHOR\n"
            fi
          done
          
          if [ -n "$INVALID_COMMITS" ]; then
            echo "has_invalid=true" >> $GITHUB_OUTPUT
            echo -e "$INVALID_COMMITS" > invalid_commits.txt
            exit 1
          else
            echo "has_invalid=false" >> $GITHUB_OUTPUT
            echo "All commit messages follow the format ✓"
          fi

      - name: Comment on PR with issues
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ⚠️ PR Compliance Issues\n\n';
            let hasIssues = false;
            
            // Check for unsigned commits
            if (fs.existsSync('unsigned_commits.txt')) {
              const unsigned = fs.readFileSync('unsigned_commits.txt', 'utf8');
              comment += '### Missing Sign-offs\n\n';
              comment += 'The following commits are missing the required sign-off:\n\n';
              comment += unsigned;
              comment += '\n**How to fix:**\n';
              comment += '```bash\n';
              comment += 'git rebase --signoff origin/${{ github.event.pull_request.base.ref }}\n';
              comment += 'git push --force-with-lease\n';
              comment += '```\n\n';
              hasIssues = true;
            }
            
            // Check for invalid commit messages
            if (fs.existsSync('invalid_commits.txt')) {
              const invalid = fs.readFileSync('invalid_commits.txt', 'utf8');
              comment += '### Invalid Commit Message Format\n\n';
              comment += 'The following commits do not follow the [Conventional Commits](https://www.conventionalcommits.org/) format:\n\n';
              comment += invalid;
              comment += '\n**Expected format:** `type(scope): description`\n\n';
              comment += '**Allowed types:** feat, fix, docs, style, refactor, perf, test, build, chore, revert, contributors, misc\n\n';
              comment += '**How to fix:**\n';
              comment += '```bash\n';
              comment += 'git rebase -i origin/${{ github.event.pull_request.base.ref }}\n';
              comment += '# Edit commit messages to follow the format\n';
              comment += 'git push --force-with-lease\n';
              comment += '```\n\n';
              hasIssues = true;
            }
            
            if (hasIssues) {
              comment += '---\n\n';
              comment += 'Please fix these issues before your PR can be merged. ';
              comment += 'See [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md) for more details.\n';
              
              // Find existing bot comment and update or create new one
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('PR Compliance Issues')
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
              }
            }

      - name: Comment success on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = '## ✅ PR Compliance Check Passed\n\n' +
                          'All commits are properly signed off and follow the required format.\n';
            
            // Find and delete old bot comments about issues
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Compliance')
            );
            
            if (botComment) {
              if (botComment.body.includes('Issues')) {
                // Delete old issue comment and post success
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
              }
            }
