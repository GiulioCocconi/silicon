name: PR Compliance Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Check and fix whitespace issues
        id: whitespace
        run: |
          set +e
          
          echo "Checking for whitespace issues..."
          
          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"
          
          # Check for trailing whitespace, spaces before tabs, etc.
          git diff --check $BASE_REF...HEAD > whitespace_errors.txt 2>&1

          if [ $? -ne 0 ]; then
            echo "has_whitespace_issues=true" >> $GITHUB_OUTPUT
            echo "Whitespace issues found"
          else
            echo "has_whitespace_issues=false" >> $GITHUB_OUTPUT
            echo "No whitespace issues found ✓"
          fi

      - name: Check commit compliance
        id: check
        run: |
          set +e  # Don't exit on error

          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"
          COMMITS=$(git log --no-merges --format="%H" $BASE_REF..HEAD)
          
          # Allowed types from CONTRIBUTING.md
          TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|contributors|misc"
          
          UNSIGNED=""
          INVALID=""
          
          while IFS= read -r commit; do
            [[ -z "$commit" ]] && continue

            msg=$(git log --format=%B -n 1 "$commit")
            subject=$(git log --format=%s -n 1 "$commit")
            author=$(git log --format=%an -n 1 "$commit")
            short="${commit:0:7}"
            
            # Check sign-off
            if ! echo "$msg" | grep -q "^Signed-off-by:"; then
              UNSIGNED+="* $short - \"$subject\" by $author"$'\n'
            fi

            # Check commit format
            if ! echo "$subject" | grep -qE "^($TYPES)(\(.+\))?: .+"; then
              INVALID+="* $short - \"$subject\" by $author"$'\n'
            fi
          done <<< "$COMMITS"

          # Set outputs
          if [[ -n "$UNSIGNED" ]]; then
            echo "has_unsigned=true" >> $GITHUB_OUTPUT
            echo "$UNSIGNED" > unsigned_commits.txt
          else
            echo "has_unsigned=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ -n "$INVALID" ]]; then
            echo "has_invalid=true" >> $GITHUB_OUTPUT
            echo "$INVALID" > invalid_commits.txt
          else
            echo "has_invalid=false" >> $GITHUB_OUTPUT
          fi

      - name: Check AUTHORS.md file
        id: authors
        run: |
          set +e
          PR_USER="${{ github.actor }}"

          # Check if user is a bot (e.g., dependabot[bot])
          if [[ "$PR_USER" == *"[bot]"* ]]; then
            echo "User is a bot ($PR_USER). Skipping AUTHORS.md check."
            echo "is_missing=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"

          echo "Checking if @$PR_USER is in AUTHORS.md..."

          # Check if user exists in base AUTHORS.md file
          # We use git show to check the file content in the base branch
          if git show "$BASE_REF:AUTHORS.md" | grep -q "@$PR_USER"; then
            echo "User already found in AUTHORS.md. Skipping check."
            echo "is_missing=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "User not found in base AUTHORS.md. Verifying addition..."

          # 1. Check if AUTHORS.md file is modified in this PR
          if ! git diff --name-only "$BASE_REF...HEAD" | grep -q "^AUTHORS\.md$"; then
            echo "Error: AUTHORS.md file not modified."
            echo "is_missing=true" >> $GITHUB_OUTPUT
            echo "error_type=no_file_change" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2. Check if the specific commit message exists
          REQUIRED_MSG="contributors: add @$PR_USER to AUTHORS.md"
          if ! git log "$BASE_REF..HEAD" --format=%s | grep -Fq "$REQUIRED_MSG"; then
            echo "Error: specific commit message missing."
            echo "is_missing=true" >> $GITHUB_OUTPUT
            echo "error_type=bad_message" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "New contributor checks passed."
          echo "is_missing=false" >> $GITHUB_OUTPUT

      - name: Update PR comment
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Collect status
            const hasUnsigned = '${{ steps.check.outputs.has_unsigned }}' === 'true';
            const hasInvalid = '${{ steps.check.outputs.has_invalid }}' === 'true';
            const hasWhitespace = '${{ steps.whitespace.outputs.has_whitespace_issues }}' === 'true';
            const authorsMissing = '${{ steps.authors.outputs.is_missing }}' === 'true';
            const authorsErrorType = '${{ steps.authors.outputs.error_type }}';
            const prUser = '${{ github.actor }}';

            let comment = '';
            
            if (hasUnsigned || hasInvalid || hasWhitespace || authorsMissing) {
              comment = '## ⚠️ PR Compliance Issues\n\n';
              comment += 'Please fix the following issues before your PR can be merged.\n\n';
              
              // 1. AUTHORS.md File (First-time contributors)
              if (authorsMissing) {
                comment += '### ❌ AUTHORS.md Check\n\n';
                comment += `It looks like your username (**@${prUser}**) is not in the \`AUTHORS.md\` file.\n\n`;

                if (authorsErrorType === 'no_file_change') {
                  comment += '- You must add yourself to the `AUTHORS.md` file.\n';
                }

                if (authorsErrorType === 'bad_message') {
                   comment += '- You modified the `AUTHORS.md` file, but the commit message format is incorrect.\n';
                }

                comment += '\nPlease ensure you have a separate commit with the exact subject:\n';
                comment += `\`contributors: add @${prUser} to AUTHORS.md\`\n\n`;
              }


              // 2. Invalid Commit Format
              if (hasInvalid) {
                const invalid = fs.readFileSync('invalid_commits.txt', 'utf8');
                comment += '### ❌ Invalid Commit Message Format\n\n';
                comment += 'The following commits do not follow the required format:\n\n';
                comment += invalid;
                comment += '\n**Expected format:** `type(scope): description`\n';
                comment += '**Allowed types:** feat, fix, docs, style, refactor, perf, test, build, chore, revert, contributors, misc\n\n';
                comment += '<details><summary><b>Click to see how to fix</b></summary>\n\n';
                comment += '```bash\n';
                comment += 'git rebase -i origin/${{ github.event.pull_request.base.ref }}\n';
                comment += '# Edit commit messages to follow the format\n';
                comment += 'git push --force-with-lease\n';
                comment += '```\n';
                comment += '</details>\n\n';
              }


              // 3. Unsigned Commits
              if (hasUnsigned) {
                const unsigned = fs.readFileSync('unsigned_commits.txt', 'utf8');
                comment += '### ❌ Missing Sign-offs\n\n';
                comment += 'The following commits are missing the required sign-off:\n\n';
                comment += unsigned;
                comment += '\n<details><summary><b>Click to see how to fix</b></summary>\n\n';
                comment += '```bash\n';
                comment += 'git rebase --signoff origin/${{ github.event.pull_request.base.ref }}\n';
                comment += 'git push --force-with-lease\n';
                comment += '```\n';
                comment += '</details>\n\n';
              }

              // 4. Whitespace
              if (hasWhitespace) {
                const whitespaceErrors = fs.readFileSync('whitespace_errors.txt', 'utf8');
                comment += '### ❌ Whitespace Issues\n\n';
                comment += 'The following files have whitespace issues:\n\n';
                comment += '```\n' + whitespaceErrors + '```\n\n';
                comment += '<details><summary><b>Click to see how to fix</b></summary>\n\n';
                comment += '```bash\n';
                comment += 'git rebase --whitespace=fix origin/${{ github.event.pull_request.base.ref }}\n';
                comment += 'git push --force-with-lease\n';
                comment += '```\n';
                comment += '</details>\n\n';
              }



              comment += '---\n';
              comment += 'See [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md) for details.\n';
            } else {
              comment = '## ✅ PR Compliance Check Passed\n\n' +
                       'All checks passed:\n' +
                       '- [x] No whitespace issues\n' +
                       '- [x] All commits signed off + formatted correctly\n' +
                       "- [x] `AUTHORS.md` file contains the PR's author username\n";
            }
            
            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('PR Compliance')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Fail workflow if issues found
        if: |
          steps.whitespace.outputs.has_whitespace_issues == 'true' ||
          steps.check.outputs.has_unsigned == 'true' ||
          steps.check.outputs.has_invalid == 'true' ||
          steps.authors.outputs.is_missing == 'true'
        run: |
          echo "Compliance checks failed. See the PR comment for details."
          exit 1