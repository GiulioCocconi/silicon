name: PR Compliance Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Check and fix whitespace issues
        id: whitespace
        run: |
          set +e
          
          echo "Checking for whitespace issues..."
          
          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"
          
          # Check for trailing whitespace, spaces before tabs, etc.
          git diff --check $BASE_REF...HEAD > whitespace_errors.txt 2>&1

          if [ $? -ne 0 ]; then
            echo "has_whitespace_issues=true" >> $GITHUB_OUTPUT
            echo "Whitespace issues found"
            cat whitespace_errors.txt
            exit 1
          else
            echo "has_whitespace_issues=false" >> $GITHUB_OUTPUT
            echo "No whitespace issues found ✓"
          fi

      - name: Check compliance
        id: check
        run: |
          set +e  # Don't exit on error

          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"
          COMMITS=$(git log --format="%H" $BASE_REF..HEAD)
          
          # Allowed types from CONTRIBUTING.md
          TYPES="feat|fix|docs|style|refactor|perf|test|build|chore|revert|contributors|misc"
          
          UNSIGNED=""
          INVALID=""
          
          while IFS= read -r commit; do
            [[ -z "$commit" ]] && continue

            msg=$(git log --format=%B -n 1 "$commit")
            subject=$(git log --format=%s -n 1 "$commit")
            author=$(git log --format=%an -n 1 "$commit")
            short="${commit:0:7}"
            
            # Check sign-off
            if ! echo "$msg" | grep -q "^Signed-off-by:"; then
              UNSIGNED+="* $short - \"$subject\" by $author"$'\n'
            fi

            # Check commit format
            if ! echo "$subject" | grep -qE "^($TYPES)(\(.+\))?: .+"; then
              INVALID+="* $short - \"$subject\" by $author"$'\n'
            fi
          done <<< "$COMMITS"

          # Set outputs
          if [[ -n "$UNSIGNED" ]]; then
            echo "has_unsigned=true" >> $GITHUB_OUTPUT
            echo "$UNSIGNED" > unsigned_commits.txt
          else
            echo "has_unsigned=false" >> $GITHUB_OUTPUT
            echo "All commits are signed off ✓"
          fi
          
          if [[ -n "$INVALID" ]]; then
            echo "has_invalid=true" >> $GITHUB_OUTPUT
            echo "$INVALID" > invalid_commits.txt
          else
            echo "has_invalid=false" >> $GITHUB_OUTPUT
            echo "All commit messages follow the format ✓"
          fi

          # Exit with error if any issues found
          [[ -n "$UNSIGNED" || -n "$INVALID" ]] && exit 1 || exit 0

      - name: Update PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const hasUnsigned = '${{ steps.check.outputs.has_unsigned }}' === 'true';
            const hasInvalid = '${{ steps.check.outputs.has_invalid }}' === 'true';
            const hasWhitespace = '${{ steps.whitespace.outputs.has_whitespace_issues }}' === 'true';
            
            let comment = '';
            
            if (hasUnsigned || hasInvalid || hasWhitespace) {
              comment = '## ⚠️ PR Compliance Issues\n\n';
              
              if (hasWhitespace && fs.existsSync('whitespace_errors.txt')) {
                const whitespaceErrors = fs.readFileSync('whitespace_errors.txt', 'utf8');
                comment += '### Whitespace Issues\n\n';
                comment += 'The following files have whitespace issues:\n\n';
                comment += '```\n' + whitespaceErrors + '```\n\n';
                comment += '**Fix:**\n';
                comment += '```bash\n';
                comment += '# Automatically fix whitespace issues\n';
                comment += 'git rebase --whitespace=fix origin/${{ github.event.pull_request.base.ref }}\n';
                comment += 'git push --force-with-lease\n';
                comment += '```\n\n';
              }
              
              if (hasUnsigned) {
                const unsigned = fs.readFileSync('unsigned_commits.txt', 'utf8');
                comment += '### Missing Sign-offs\n\n';
                comment += 'The following commits are missing the required sign-off:\n\n';
                comment += unsigned;
                comment += '\n**Fix:**\n';
                comment += '```bash\n';
                comment += 'git rebase --signoff origin/${{ github.event.pull_request.base.ref }}\n';
                comment += 'git push --force-with-lease\n';
                comment += '```\n\n';
              }
              
              if (hasInvalid) {
                const invalid = fs.readFileSync('invalid_commits.txt', 'utf8');
                comment += '### Invalid Commit Message Format\n\n';
                comment += 'The following commits do not follow the [Conventional Commits](https://www.conventionalcommits.org/) format:\n\n';
                comment += invalid;
                comment += '\n**Expected format:** `type(scope): description`\n\n';
                comment += '**Allowed types:** feat, fix, docs, style, refactor, perf, test, build, chore, revert, contributors, misc\n\n';
                comment += '**Fix:**\n';
                comment += '```bash\n';
                comment += 'git rebase -i origin/${{ github.event.pull_request.base.ref }}\n';
                comment += '# Edit commit messages to follow the format\n';
                comment += 'git push --force-with-lease\n';
                comment += '```\n\n';
              }

              comment += '---\n\n';
              comment += 'Please fix these issues before your PR can be merged. ';
              comment += 'See [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md) for details.\n';
            } else {
              comment = '## ✅ PR Compliance Check Passed\n\n' +
                       'All commits are properly signed off, follow the required format, and have no whitespace issues.\n';
            }
            
            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('PR Compliance')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }