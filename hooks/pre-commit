#!/bin/sh
#
# Pre-commit hook to run clang-format on staged files before committing.

# --- Configuration ---
# List of file extensions to format (space-separated, case-insensitive).
# Add or remove extensions as needed for your project.
FORMAT_EXTENSIONS="cpp hpp"
# --- End Configuration ---

# Function to check if a file extension matches the allowed list
should_format() {
    local filename="$1"
    local extension="${filename##*.}"

    for ext in $FORMAT_EXTENSIONS; do
        if [ "$extension" = "$ext" ]; then
            return 0 # True, should format
        fi
    done
    return 1 # False, should not format
}

## MAIN

if ! command -v clang-format > /dev/null 2>&1; then
    echo "Error: clang-format is not installed or not in PATH." >&2
    echo "Please install clang-format to use this pre-commit hook." >&2
    exit 1
fi

echo "Running clang-format hook..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No files staged for commit."
    exit 0
fi

FILES_TO_FORMAT=""
# Filter the staged files by extension
for file in $STAGED_FILES; do
    if should_format "$file"; then
        # Check if the file actually exists (it should with filter=ACM, but be safe)
        if [ -f "$file" ]; then
            FILES_TO_FORMAT="$FILES_TO_FORMAT $file"
        fi
    fi
done

# Trim leading space if necessary
FILES_TO_FORMAT=$(echo "$FILES_TO_FORMAT" | sed 's/^ *//')

if [ -z "$FILES_TO_FORMAT" ]; then
    echo "No relevant files staged for formatting."
    exit 0
fi

echo "Formatting staged files:"
# Use xargs to pass the files to clang-format.
# Use echo to handle filenames potentially containing spaces (though git diff usually separates by newline).
# Using a loop might be safer for complex filenames, but xargs is often sufficient.
echo $FILES_TO_FORMAT | xargs clang-format -i

# Check if clang-format modified any files
# We could check git status, but simply re-adding is easier and generally safe.

echo "Re-staging formatted files..."
# Re-add the formatted files to the staging area
echo $FILES_TO_FORMAT | xargs git add

echo "clang-format hook finished."

# Exit with 0 to allow the commit
exit 0
